<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MentorIA - Antioquia Educada</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --green:#10B981;
    --bot-gray:#e9e9ea;
    --text-black:#111;
    --bg:#f0f4f8;
    --card-bg:#ffffff;
    --max-width:920px;
    --accent:#3369FF;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;font-family:'Nunito',sans-serif;background:var(--bg);-webkit-font-smoothing:antialiased}
  /* --- Screen handling --- */
  .screen{display:none;height:100vh;width:100%}
  .active{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}

  /* --- Common containers --- */
  .wrap{width:100%;max-width:var(--max-width);margin:0 auto;padding:16px}

  /* --- Pantalla 1 (splash) --- */
  #screen1{background:var(--green);color:#fff}
  #screen1 .wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh}
  #screen1 img{width:160px;height:auto;margin-bottom:18px}
  #screen1 h1{font-size:2.4rem;margin:0;font-weight:700}

  /* --- Pantalla 2 (bienvenida) --- */
  #screen2{background:var(--card-bg);color:var(--text-black);display:flex;align-items:center;justify-content:center}
  /* forzar centrado seguro */
  #screen2 .wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:22px}
  #screen2 .card{width:100%;max-width:720px;background:var(--card-bg);border-radius:14px;padding:22px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  #screen2 h2{color:var(--green);font-size:1.6rem;margin:0 0 8px 0}
  #screen2 p{max-width:640px;margin:8px 0 18px 0;color:#333}
  #screen2 img{width:220px;max-width:60%;height:auto;margin:12px 0}
  #screen2 .consent{display:flex;align-items:center;gap:12px;margin-top:12px}
  #startBtn{display:inline-block;margin-top:16px;padding:12px 18px;border-radius:10px;border:none;background:var(--green);color:#fff;cursor:pointer;font-weight:700;font-size:1rem}
  #startBtn:disabled{opacity:.55;cursor:not-allowed}

  /* --- Pantalla 3 (chat) --- */
  #screen3{height:100vh;width:100%;display:flex;flex-direction:column;align-items:stretch}
  .topbar{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--card-bg);border-bottom:1px solid #ececec;position:sticky;top:0;z-index:10}
  .topbar .left{display:flex;align-items:center;gap:12px}
  .back{cursor:pointer;padding:6px;border-radius:8px;display:flex;align-items:center;justify-content:center}
  .back:hover{background:#f5f5f5}
  .topbar img{width:52px;height:52px;border-radius:50%;object-fit:cover}
  .meta{display:flex;flex-direction:column;align-items:flex-start}
  .meta h3{margin:0;font-size:1.15rem;font-weight:700}
  .meta .status{margin-top:6px;color:var(--green);font-weight:600;font-size:0.95rem;text-align:left;max-width:calc(100vw - 160px)}

  .chat-container{flex:1;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-end;padding:12px;background:var(--bg);min-height:0}
  #chatbox{flex:1;max-width:var(--max-width);width:100%;margin:0 auto;display:flex;flex-direction:column;gap:12px;padding:12px;overflow-y:auto;scroll-behavior:smooth}
  .bubble-row{display:flex;align-items:flex-end;gap:10px}
  .bubble-row.bot{justify-content:flex-start}
  .bubble-row.user{justify-content:flex-end}
  .avatar{width:44px;height:44px;border-radius:50%;flex-shrink:0;object-fit:cover}
  .bubble{max-width:78%;padding:10px 14px;border-radius:14px;font-size:1rem;line-height:1.25;word-wrap:break-word;white-space:pre-wrap}
  .bubble.bot{background:var(--bot-gray);color:var(--text-black);border-bottom-left-radius:6px}
  .bubble.user{background:var(--green);color:#fff;border-bottom-right-radius:6px}

  /* typing bubble specific */
  .bubble.bot.typing { display:flex; align-items:center; gap:8px; padding:10px 16px; min-width:56px; justify-content:center; }
  .bubble.bot.typing span { width:8px; height:8px; background:#6b7280; border-radius:50%; display:inline-block; animation:blink 1.4s infinite both; opacity:.3; transform:translateY(0); }
  .bubble.bot.typing span:nth-child(2){ animation-delay:0.18s; }
  .bubble.bot.typing span:nth-child(3){ animation-delay:0.36s; }
  @keyframes blink { 0%,80%,100%{ opacity:.3; transform:translateY(0);} 40%{ opacity:1; transform:translateY(-3px);} }

  /* source badge */
  .source-badge{font-size:12px;color:#666;margin-left:56px;margin-top:-6px}

  /* composer */
  .composer{max-width:var(--max-width);width:100%;margin:8px auto 18px auto;display:flex;align-items:center;gap:10px;padding:10px 12px;background:transparent}
  .input-wrap{flex:1;display:flex;align-items:center;background:var(--card-bg);padding:8px;border-radius:999px;border:1px solid #e6e6e6}
  .input-wrap input{border:0;outline:none;padding:10px 12px;font-size:1rem;background:transparent;color:var(--text-black);flex:1}
  .send-btn{background:var(--green);border:none;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;box-shadow:0 6px 18px rgba(16,185,129,0.12)}
  .send-btn[disabled]{opacity:.6;cursor:not-allowed}
  .spinner{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* small screens adjustments */
  @media (max-width:900px){
    :root{--max-width:720px}
    .topbar img{width:48px;height:48px}
    .avatar{width:40px;height:40px}
  }
  @media (max-width:600px){
    :root{--max-width:440px}
    #screen1 img{width:140px}
    #screen1 h1{font-size:2rem}
    .topbar img{width:44px;height:44px}
    .meta .status{font-size:0.88rem}
    .send-btn{width:44px;height:44px}
    .input-wrap input{font-size:0.95rem}
    .bubble{font-size:0.95rem}
    .source-badge{margin-left:52px}
  }
  @media (max-width:400px){
    :root{--max-width:360px}
    .meta .status{font-size:0.82rem}
    .avatar{width:36px;height:36px}
    .topbar img{width:40px;height:40px}
    .source-badge{margin-left:48px}
  }
</style>
</head>
<body>

<!-- Pantalla 1 (splash) -->
<div id="screen1" class="screen active">
  <div class="wrap">
    <img src="/static/image1.png" alt="MentorIA">
    <h1>MentorIA</h1>
  </div>
</div>

<!-- Pantalla 2 (bienvenida / consentimiento) -->
<div id="screen2" class="screen">
  <div class="wrap card">
    <h2>Tu Asistente Educativo color</h2>
    <p>Aprende de forma personalizada con un tutor virtual que se adapta a tu ritmo y contexto.</p>
    <img src="/static/image2.png" alt="Robot asistente">
    <div class="consent" style="justify-content:center; margin-top:16px;">
      <input type="checkbox" id="consent">
      <label for="consent">Aceptar políticas
de privacidad</label>
    </div>
    <div style="display:flex;justify-content:center">
      <button id="startBtn" disabled>Comenzar</button>
    </div>
  </div>
</div>

<!-- Pantalla 3 (chat) -->
<div id="screen3" class="screen" aria-live="polite">
  <div class="topbar">
    <div class="left">
      <div class="back" id="backBtn" title="Volver" aria-label="Volver">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18L9 12L15 6" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <img src="/static/image1.png" alt="MentorIA" />
      <div class="meta">
        <h3 style="color: #3369FF">MentorIA</h3>
        <div>
            <span style="color: #3ABF38;">•</span>
            <span style="color: #10B981;">En línea</span>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <div id="chatbox" role="log" aria-live="polite">
      <div class="bubble-row bot">
        <img class="avatar" src="/static/image1.png" alt="MentorIA">
        <div class="bubble bot">¡Hola! Soy MentorIA, tu tutor virtual de Antioquia. ¿Qué tema quieres aprender hoy?</div>
      </div>
    </div>

    <div class="composer">
      <div class="input-wrap" id="inputWrap" role="form" aria-label="Campo de mensaje">
        <input id="userInput" type="text" placeholder="Escribe tu pregunta..." autocomplete="off" aria-label="Escribir mensaje" />
      </div>

      <button id="sendBtn" class="send-btn" title="Enviar" aria-label="Enviar mensaje">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M22 2L11 13" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // ---------- UI helpers (únicos y consistentes) ----------
  function showScreen(n){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const el = document.getElementById('screen'+n);
    if(el) el.classList.add('active');
    if(n===3) {
      // asegurar scroll y foco si hay chat
      setTimeout(()=> {
        const chatbox = document.getElementById('chatbox');
        if(chatbox) chatbox.scrollTop = chatbox.scrollHeight;
        const inp = document.getElementById('userInput');
        if(inp) inp.focus();
      }, 60);
    }
  }

  function scrollChatToBottom(){
    setTimeout(()=> { 
      const chatbox = document.getElementById('chatbox');
      if(chatbox) chatbox.scrollTop = chatbox.scrollHeight; 
    }, 60);
  }

  function appendUserMessage(text){
    const row = document.createElement('div');
    row.className = 'bubble-row user';
    const bubble = document.createElement('div');
    bubble.className = 'bubble user';
    bubble.textContent = text;
    row.appendChild(bubble);
    chatbox.appendChild(row);
    scrollChatToBottom();
  }

  function appendBotMessage(text, source){
    const row = document.createElement('div');
    row.className = 'bubble-row bot';
    const avatar = document.createElement('img');
    avatar.className = 'avatar';
    avatar.src = '/static/image1.png';
    avatar.alt = 'MentorIA';
    const bubble = document.createElement('div');
    bubble.className = 'bubble bot';
    bubble.textContent = text;
    row.appendChild(avatar);
    row.appendChild(bubble);
    chatbox.appendChild(row);
    scrollChatToBottom();
  }

  // --- typing indicator management ---
  let typingIndicator = null;
  function showTyping(){
    // si ya está, no añadir otra vez
    if(typingIndicator) return;
    typingIndicator = document.createElement('div');
    typingIndicator.className = 'bubble-row bot';
    typingIndicator.innerHTML = `
      <img class="avatar" src="/static/image1.png" alt="MentorIA">
      <div class="bubble bot typing">
        <span></span><span></span><span></span>
      </div>`;
    chatbox.appendChild(typingIndicator);
    scrollChatToBottom();
  }

  function hideTyping(){
    if(typingIndicator){
      typingIndicator.remove();
      typingIndicator = null;
    }
  }

  function setSendingState(isSending){
    const sendBtn = document.getElementById('sendBtn');
    if(isSending){
      sendBtn.disabled = true;
      // ya no cambiamos el contenido del botón; mostramos el typing en el chat
    } else {
      sendBtn.disabled = false;
      // el contenido del botón permanece como la flecha SVG original
    }
  }

  // Demo: 1 -> 2 después de 1.2s (breve splash)
  setTimeout(()=> showScreen(2), 1200);

  // ---------- Robust startBtn handler ----------
  (function(){
    const consentEl = document.getElementById('consent');
    const startBtnEl = document.getElementById('startBtn');

    if(!consentEl || !startBtnEl) return;

    // Estado inicial
    startBtnEl.disabled = !consentEl.checked;

    // Toggle disabled según checkbox (asegurando sólo un listener)
    consentEl.addEventListener('change', ()=> startBtnEl.disabled = !consentEl.checked );

    // Click handler robusto
    startBtnEl.addEventListener('click', function(e){
      e.preventDefault();
      if(!consentEl.checked) return;
      try{
        showScreen(3);
        setTimeout(()=> {
          const inp = document.getElementById('userInput');
          if(inp) inp.focus();
        }, 220);
      }catch(err){
        console.error("Error al intentar cambiar a pantalla 3:", err);
      }
    });
  })();

  // Back (vuelve a pantalla 2)
  document.getElementById('backBtn').addEventListener('click', ()=> showScreen(2) );

  // ---------- Chat logic ----------
  const chatbox = document.getElementById('chatbox');
  const userInput = document.getElementById('userInput');

  // única definición de handleSend
  async function handleSend(){
    const text = (userInput.value || '').trim();
    if(!text) return;
    appendUserMessage(text);
    userInput.value = '';
    setSendingState(true);
    showTyping();

    try {
      const res = await fetch('/chat_ext', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message: text })
      });
      if(!res.ok) throw new Error('Status ' + res.status);
      const data = await res.json();

      hideTyping();
      const respuesta = data.response || 'No recibí respuesta del servidor.';
      const source = data.source || 'desconocida';
      appendBotMessage(respuesta, source);

      // abrir quiz si viene
      if (data.quiz_url) {
        try { window.open(data.quiz_url, '_blank', 'noopener,noreferrer'); } catch(e){ console.warn("No se pudo abrir la pestaña del quiz:", e); }
      }
    } catch (err) {
      hideTyping();
      appendBotMessage('Error: no pude comunicarme con el servidor. ' + (err.message || ''), 'local');
      console.error(err);
    } finally {
      setSendingState(false);
    }
  }

  // enviar con Enter o clic (listeners añadidos tras definir handleSend)
  const sendBtn = document.getElementById('sendBtn');
  sendBtn.addEventListener('click', handleSend);
  userInput.addEventListener('keydown', function(e){
    if(e.key === 'Enter'){ e.preventDefault(); handleSend(); }
  });

  // accesibilidad: enfocar input al mostrar pantalla de chat
  const observer = new MutationObserver(muts=>{
    muts.forEach(m=>{
      if(m.target.classList && m.target.classList.contains('active') && m.target.id==='screen3'){
        setTimeout(()=> userInput.focus(), 220);
      }
    });
  });
  observer.observe(document.getElementById('screen3'), { attributes:true });

</script>
</body>
</html>